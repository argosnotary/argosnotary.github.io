(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{115:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return c})),n.d(t,"rightToc",(function(){return s})),n.d(t,"default",(function(){return p}));var a=n(2),r=n(6),i=(n(0),n(127)),o={id:"20_layout",title:"Layout",sidebar_label:"Layout"},c={id:"70_reference/20_layout",title:"Layout",description:":::caution",source:"@site/docs/70_reference/20_layout.md",permalink:"/docs/70_reference/20_layout",editUrl:"https://github.com/argosnotary/docs/tree/master/docs/70_reference/20_layout.md",sidebar_label:"Layout",sidebar:"docs",previous:{title:"wip",permalink:"/docs/60_supplychain_management/10_wip"},next:{title:"Link",permalink:"/docs/70_reference/21_link"}},s=[{value:"Introduction",id:"introduction",children:[]},{value:"Layout",id:"layout",children:[{value:"Class diagram",id:"class-diagram",children:[]}]},{value:"LayoutSegment",id:"layoutsegment",children:[]},{value:"Artifact Rules",id:"artifact-rules",children:[{value:"MatchRule",id:"matchrule",children:[]},{value:"Rule processing",id:"rule-processing",children:[]}]},{value:"Specification",id:"specification",children:[]},{value:"JSON Sample",id:"json-sample",children:[]}],l={rightToc:s};function p(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(i.b)("wrapper",Object(a.a)({},l,n,{components:t,mdxType:"MDXLayout"}),Object(i.b)("div",{className:"admonition admonition-caution alert alert--warning"},Object(i.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(i.b)("h5",{parentName:"div"},Object(i.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(i.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"}),Object(i.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"})))),"caution")),Object(i.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(i.b)("p",{parentName:"div"},"This is page is work in progress"))),Object(i.b)("h2",{id:"introduction"},"Introduction"),Object(i.b)("p",null,"A Layout in Argos Notary dictates the series of steps that need to be carried out in the Software Supply Chain to create the final end product. The layout includes ordered segments and steps, requirements for the steps, and the list of actors (or functionaries) in charge of carrying out every step. The steps within the supply chain are laid out by a project owner."),Object(i.b)("p",null,"The Layout is stored in Argos Notary together with its signature(s) in a Metadata object. A Layout is only valid with the required number of authorized signatures. "),Object(i.b)("h2",{id:"layout"},"Layout"),Object(i.b)("p",null,"A Layout should be signed by one ore more of the authorized persons. The persons are authorized by their RSA key identifier in the authorizedKeyIds list."),Object(i.b)("p",null,"The Expected End Products is a list of ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"#matchrule"}),"Match Rules")," which should match all software products delivered by the Software Supply Chain"),Object(i.b)("p",null,"The Layout Segments with the Match Rules in its steps with a destination in other segments should be a directed graph beginning in the Expected End Products."),Object(i.b)("h3",{id:"class-diagram"},"Class diagram"),Object(i.b)("p",null,Object(i.b)("img",Object(a.a)({parentName:"p"},{src:"/img/plantuml/70_reference_layout.svg",alt:"Layout"}))),Object(i.b)("h2",{id:"layoutsegment"},"LayoutSegment"),Object(i.b)("h2",{id:"artifact-rules"},Object(i.b)("a",Object(a.a)({parentName:"h2"},{href:"21_link#artifact"}),"Artifact")," Rules"),Object(i.b)("p",null,'Rules in Argos Notary can be compared with firewall rules. The rules enforce the existence of artifacts before running of a step(expected materials) or after running of the step(expected products). As an example, the "build" step can use the materials from the "checkout-git" step and has a jar artifact in the products. '),Object(i.b)("p",null,"All rules have a glob pattern equivalent with ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://git-scm.com/docs/gitignore"}),"gitignore")," pattern matching. The pattern will be matched against paths reported for materials or products in the ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"21_link"}),"link")," data. The following rules can be specified:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"MATCH: The MatchRule will be explained in ",Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#matchrule"}),"MatchRule"),"."),Object(i.b)("li",{parentName:"ul"},"ALLOW: indicates that artifacts matched by the pattern are allowed and consumed by this rule."),Object(i.b)("li",{parentName:"ul"},"DISALLOW: indicates that artifacts matched by the pattern are not allowed."),Object(i.b)("li",{parentName:"ul"},"REQUIRE: indicates that a pattern must appear and are consumed by this rule."),Object(i.b)("li",{parentName:"ul"},"CREATE: indicates that products matched by the pattern must not appear as materials of the step."),Object(i.b)("li",{parentName:"ul"},"DELETE: indicates that materials matched by the pattern must not appear as products of the step."),Object(i.b)("li",{parentName:"ul"},"MODIFY: indicates that products matched by this pattern must appear as materials of the step, and their hashes must not by the same.")),Object(i.b)("h3",{id:"matchrule"},"MatchRule"),Object(i.b)("p",null,"A MatchRule indicates that the artifacts filtered using ",Object(i.b)("inlineCode",{parentName:"p"},"sourcePathPrefix/pattern")," must be matched to a ",Object(i.b)("inlineCode",{parentName:"p"},"destinationType"),"(",Object(i.b)("inlineCode",{parentName:"p"},"MATERIALS")," or ",Object(i.b)("inlineCode",{parentName:"p"},"PRODUCTS"),") from a destination step and segment with the ",Object(i.b)("inlineCode",{parentName:"p"},"destinationPathPrefix/pattern")," filter. For example, match ",Object(i.b)("inlineCode",{parentName:"p"},"foo")," with ",Object(i.b)("inlineCode",{parentName:"p"},"PRODUCTS")," from ",Object(i.b)("inlineCode",{parentName:"p"},"compilation")," in segment ",Object(i.b)("inlineCode",{parentName:"p"},"jenkins")," indicates that the file ",Object(i.b)("inlineCode",{parentName:"p"},"foo"),", a product of the step ",Object(i.b)("inlineCode",{parentName:"p"},"compilation")," in the segment ",Object(i.b)("inlineCode",{parentName:"p"},"jenkins"),", must correspond to either a material or a product in this step (depending on where this artifact rule was listed). More complex uses of the MATCH rule are presented in the examples of section 5.3."),Object(i.b)("p",null,"The ",Object(i.b)("inlineCode",{parentName:"p"},"sourcePathPrefix"),", ",Object(i.b)("inlineCode",{parentName:"p"},"destinationPathPrefix")," and  ",Object(i.b)("inlineCode",{parentName:"p"},"destinationSegmentName")," properties are optional, The ",Object(i.b)("inlineCode",{parentName:"p"},"pathPrefixes")," are used to match products and materials whose path differs from the one presented in the destination step. This is the case for steps that relocate files as part of their tasks. For example match ",Object(i.b)("inlineCode",{parentName:"p"},"foo")," with ",Object(i.b)("inlineCode",{parentName:"p"},"sourcePathPrefix")," ",Object(i.b)("inlineCode",{parentName:"p"},"lib")," and ",Object(i.b)("inlineCode",{parentName:"p"},"destinationPathPrefix"),' build/lib will ensure that the file "lib/foo" matches "build/lib/foo" in the destination step.'),Object(i.b)("p",null,"If ",Object(i.b)("inlineCode",{parentName:"p"},"destinationSegmentName")," isn't defined the destination step should be in the same Layout Segment as the current step"),Object(i.b)("p",null,"The MatchRules in the expected end products combined with the MatchRules in the steps refering to other segments should create a directed graph of the Layout Segments."),Object(i.b)("h3",{id:"rule-processing"},"Rule processing"),Object(i.b)("p",null,"Artifact rules reside in the ",Object(i.b)("inlineCode",{parentName:"p"},"expectedProducts")," and ",Object(i.b)("inlineCode",{parentName:"p"},"expectedMaterials")," fields of a step and are applied sequentially on a queue of ",Object(i.b)("inlineCode",{parentName:"p"},"Artifacts")," or from the step's corresponding link metadata. They operate in a similar fashion as firewall rules do. This means if an artifact is successfully consumed by a rule, it is removed from the queue and cannot be consumed by subsequent rules. There is an implicit ",Object(i.b)("inlineCode",{parentName:"p"},"DISALLOW")," with the pattern ",Object(i.b)("inlineCode",{parentName:"p"},"**")," at the end of each rule list. Argos Notary verification fails if an artifact was not consumed by an earlier rule. Here, we describe an algorithm to illustrate the behavior of the rules being applied:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-python"}),"VERIFY_EXPECTED_ARTIFACTS(rules, link)\n\n# load the artifacts from the link materials\nartifacts = load_artifacts_as_queue(link.materials)\n\n# iterate over all the rules\nfor rule in rules:\n  consumed_artifacts, rule_error = apply_rule(rule, artifacts)\n\n  if rule_error:\n    return FAILURE\n\n  artifacts -= consumed_artifacts\n  \n  if not artifacts is empty:\n    return FAILURE\n\nreturn SUCCESS\n")),Object(i.b)("h2",{id:"specification"},"Specification"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"type Layout = {\n    keys: Key[],\n    authorizedKeyIds: KeyIdentifier[],\n    expectedEndProducts: MatchRule[],\n    layoutSegments: LayoutSegment[]\n}\n\ntype Key = {\n    id: KeyIdentifier,\n    key: PublicKey\n}\n\ntype KeyIdentifier = sha256(PublicKey)\n\ntype Rule = {\n    ruleType: RuleType,\n    pattern: glob pattern\n}\n\nenum RuleType = {\n    ALLOW, CREATE, DELETE, DISALLOW, MATCH, MODIFY, REQUIRE\n}\n\ntype MatchRule = {\n      ruleType: MATCH,\n      pattern: glob pattern,\n      sourcePathPrefix: unix style path,\n      destinationType: DestinationType,\n      destinationStepName: String,\n      destinationPathPrefix: unix style path,\n      destinationType: DestinationType\n      destinationStepName: String,\n      destinationSegmentName: String\n}\n\nenum DestinationType {\n    PRODUCTS, MATERIALS\n}\n\ntype LayoutSegment = {\n    name: String,\n    steps: Step[]\n}\n\ntype Step = {\n      name: String,\n      authorizedLeyIds: KeyIdentifier[],\n      requiredNumberOfLinks: Int,\n      expectedMaterials: Rule[],\n      expectedProducts: Rule[]\n}\n\n")),Object(i.b)("h2",{id:"json-sample"},"JSON Sample"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-json"}),'{\n        "keys": [\n            {\n                "id": "c8df0a497ab0df7136c4f97892f17914e6e5e021fdc039f0ea7c27d5a95c1254",\n                "key": "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAnB7t5WVvXmbwKo7vn49tDyigfZF+wqB68v4i2fgv+/625yVomAKrtQDX8ANTCbZ6UQEkXNQhI9muPo8hhYb2zEaEdEckslSQ9lFJgDHCHekC2EYwXmc4VnwLzyiITtlXSSveav5qUpGVb7t7AK4f9yueojwqUjgQGkXgmeDrg8r15G/nVuYq5WyIS3OKxXKQmm2mJTr5A+kt8SiYPmDQoJwkK6ezZU7qsobY5jloU5SdIiGn2d8KHioj5ekki9kgBszuwHHqg94Ml6JT28EWRKdfBVA2P7PRLzl3V8qdA0srkTsuy4+emEI+NAeNQkeMsucfW4xIVBMQZ28GIFmJcwIDAQAB"\n            },\n            {\n                "id": "b91bec49e7aaaeeda162970c03193baef561c10337483a8bc0741d514dc63b9c",\n                "key": "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwhHPSza/Vx1VVzlXAXByXk4z13Q4JZI6fphr0LK5mdFlckHzqNOP9FtXzDxbJawQdDkFQAIvmBRBZHOP78z7jtSGhQLY3qpIJ82ztyBT/WAH9eyX+z4eZ5vur42jLsvrn9qKcXtUXcuiMNLUzBT251aoJcgsG6+fN7J1t5bcSLfwlWNrbe4VK2kjVu3Ep6YUKXmzJQvJ97YlLsVKTfod+3IrFOJBmHbrUJUDJh09mJ5Conkp44IYNy3zwuPqaJphuiVVszlaAnO2OUnwRdJJ8qs0BNJa+n3No9CTdEU6IvirZ1j/Bjmrl6t6Lc9PhZxNQeAriHRBeFufGTvvWmS9WwIDAQAB"\n            },\n            {\n                "id": "a97daeaf3afaed859472a367da7a860b4b90eefb97fe51384bd45e9eed020b5b",\n                "key": "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEApsOT7tBT27EF2EnYenWJqRjl+2Eg8m9tEmjNc2d3pTK+wCLMFaeyoAai3cSGafSiVZd9GVaXeUlVPCF/lHUpA0GT6gdMUyynHC/vNInqXsd1d8hLKaVFsI+KWSNbU86h9h7p1nHvLlfZ55UBrtiiRafl0L0tWWhlNtiDGQlQ/ZlyM/jzYZAtHBUR0ex/SI2c8L8Wk3ZqbxoctrbHRmlqDTgGBEL+sxajHgELj8t7Nt7nKMhvEvyG3C7vckIXxBnAW8dfZtw9SEQooq2dL5u5ZyPm1zVwLyAFtOe+Fx/NC6RVt3hUnrgKHWjeEeDqKk0NYnduOSFZA7R1tOHm+iNQFQIDAQAB"\n            }\n        ],\n        "authorizedKeyIds": [\n            "c8df0a497ab0df7136c4f97892f17914e6e5e021fdc039f0ea7c27d5a95c1254"\n        ],\n        "expectedEndProducts": [\n            {\n                "pattern": "**",\n                "destinationType": "PRODUCTS",\n                "destinationStepName": "collect_dar",\n                "destinationSegmentName": "xldeploy"\n            }\n        ],\n        "layoutSegments": [\n            {\n                "name": "jenkins",\n                "steps": [\n                    {\n                        "name": "clean",\n                        "authorizedKeyIds": [\n                            "b91bec49e7aaaeeda162970c03193baef561c10337483a8bc0741d514dc63b9c"\n                        ],\n                        "requiredNumberOfLinks": 1,\n                        "expectedMaterials": [\n                            {\n                                "ruleType": "ALLOW",\n                                "pattern": "**"\n                            }\n                        ],\n                        "expectedProducts": [\n                            {\n                                "ruleType": "DISALLOW",\n                                "pattern": "target/**"\n                            },\n                            {\n                                "ruleType": "ALLOW",\n                                "pattern": "**"\n                            }\n                        ]\n                    },\n                    {\n                        "name": "build",\n                        "authorizedKeyIds": [\n                            "b91bec49e7aaaeeda162970c03193baef561c10337483a8bc0741d514dc63b9c"\n                        ],\n                        "requiredNumberOfLinks": 1,\n                        "expectedMaterials": [\n                            {\n                                "ruleType": "MATCH",\n                                "pattern": "**",\n                                "destinationType": "PRODUCTS",\n                                "destinationStepName": "clean"\n                            }\n                        ],\n                        "expectedProducts": [\n                            {\n                                "ruleType": "CREATE",\n                                "pattern": "target/argos-test-app.war"\n                            },\n                            {\n                                "ruleType": "ALLOW",\n                                "pattern": "**"\n                            }\n                        ]\n                    },\n                    {\n                        "name": "deploy",\n                        "authorizedKeyIds": [\n                            "b91bec49e7aaaeeda162970c03193baef561c10337483a8bc0741d514dc63b9c"\n                        ],\n                        "requiredNumberOfLinks": 1,\n                        "expectedMaterials": [\n                            {\n                                "ruleType": "MATCH",\n                                "pattern": "target/argos-test-app.war",\n                                "destinationType": "PRODUCTS",\n                                "destinationStepName": "build"\n                            },\n                            {\n                                "ruleType": "ALLOW",\n                                "pattern": "**"\n                            }\n                        ],\n                        "expectedProducts": [\n                            {\n                                "ruleType": "MATCH",\n                                "pattern": "target/deployit-working-dir/**",\n                                "destinationType": "PRODUCTS",\n                                "destinationStepName": "build"\n                            },\n                            {\n                                "ruleType": "MATCH",\n                                "pattern": "target/*.war",\n                                "destinationType": "MATERIALS",\n                                "destinationStepName": "deploy"\n                            },\n                            {\n                                "ruleType": "ALLOW",\n                                "pattern": "**"\n                            }\n                        ]\n                    }\n                ]\n            },\n            {\n                "name": "xldeploy",\n                "steps": [\n                    {\n                        "name": "collect_dar",\n                        "authorizedKeyIds": [\n                            "a97daeaf3afaed859472a367da7a860b4b90eefb97fe51384bd45e9eed020b5b"\n                        ],\n                        "requiredNumberOfLinks": 1,\n                        "expectedMaterials": [\n                            {\n                                "ruleType": "ALLOW",\n                                "pattern": "**"\n                            }\n                        ],\n                        "expectedProducts": [\n                            {\n                                "ruleType": "ALLOW",\n                                "pattern": "*"\n                            },\n                            {\n                                "ruleType": "MATCH",\n                                "pattern": "**",\n                                "destinationPathPrefix": "target/deployit-working-dir",\n                                "destinationType": "PRODUCTS",\n                                "destinationStepName": "build",\n                                "destinationSegmentName": "jenkins"\n                            }\n                        ]\n                    }\n                ]\n            }\n        ]\n    }\n')))}p.isMDXComponent=!0},127:function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return m}));var a=n(0),r=n.n(a);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=r.a.createContext({}),p=function(e){var t=r.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):c({},t,{},e)),n},d=function(e){var t=p(e.components);return r.a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},b=Object(a.forwardRef)((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,o=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),d=p(n),b=a,m=d["".concat(o,".").concat(b)]||d[b]||u[b]||i;return n?r.a.createElement(m,c({ref:t},l,{components:n})):r.a.createElement(m,c({ref:t},l))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=b;var c={};for(var s in t)hasOwnProperty.call(t,s)&&(c[s]=t[s]);c.originalType=e,c.mdxType="string"==typeof e?e:a,o[1]=c;for(var l=2;l<i;l++)o[l]=n[l];return r.a.createElement.apply(null,o)}return r.a.createElement.apply(null,n)}b.displayName="MDXCreateElement"}}]);